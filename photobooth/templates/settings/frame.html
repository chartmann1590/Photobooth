{% extends "base.html" %}

{% block title %}PhotoBooth Settings - Frame{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
            <i class="fas fa-image text-rose-600 mr-3"></i>
            Frame Settings
        </h1>
        <p class="mt-2 text-base md:text-lg text-gray-600">Upload and manage photo frame overlays</p>
    </div>

    <!-- Current Frame Status -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">
            <i class="fas fa-picture-o text-rose-500 mr-2"></i>
            Current Frame
        </h2>
        
        {% if has_frame %}
        <div class="flex items-center p-4 bg-green-50 border border-green-200 rounded-lg mb-6">
            <i class="fas fa-check-circle text-green-600 text-2xl mr-4"></i>
            <div>
                <h3 class="font-semibold text-green-800">Frame Active</h3>
                <p class="text-sm text-green-600">A custom frame overlay is currently being applied to photos</p>
            </div>
        </div>
        
        <!-- Frame Preview -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Preview</h3>
            <div class="max-w-md mx-auto bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-4">
                <img src="{{ url_for('static', filename='frames/current.png') }}?v={{ timestamp }}" alt="Current Frame" 
                     class="w-full h-auto rounded-lg shadow-md"
                     onload="console.log('SETTINGS FRAME PREVIEW LOADED - URL:', this.src);"
                     onerror="console.log('SETTINGS FRAME PREVIEW FAILED - URL:', this.src, 'Error:', event); this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div class="text-center text-gray-500 hidden">
                    <i class="fas fa-image text-4xl mb-2"></i>
                    <p>Frame preview not available</p>
                </div>
            </div>
        </div>
        
        <!-- Remove Frame Button -->
        <button onclick="removeFrame()" 
                class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700
                       active:scale-95 text-white font-medium py-3 px-6 rounded-xl text-base
                       shadow-lg transform transition-all duration-200 touch-manipulation">
            <i class="fas fa-trash mr-2"></i>
            Remove Current Frame
        </button>
        
        {% else %}
        <div class="flex items-center p-4 bg-amber-50 border border-amber-200 rounded-lg mb-6">
            <i class="fas fa-info-circle text-amber-600 text-2xl mr-4"></i>
            <div>
                <h3 class="font-semibold text-amber-800">No Frame Active</h3>
                <p class="text-sm text-amber-600">Upload a frame overlay to enhance your photos</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Upload New Frame -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">
            <i class="fas fa-upload text-blue-500 mr-2"></i>
            Upload New Frame
        </h2>
        <p class="text-gray-600 mb-6">Upload a PNG image with transparency to use as a photo frame overlay</p>
        
        <!-- Upload Area -->
        <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-rose-400 transition-colors">
            <input type="file" id="frameUpload" accept=".png,.jpg,.jpeg" class="hidden">
            <div id="uploadArea" onclick="document.getElementById('frameUpload').click();" class="cursor-pointer">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                <p class="text-lg text-gray-600 mb-2">Click to select frame image</p>
                <p class="text-sm text-gray-500">PNG recommended for transparent overlays</p>
                <p class="text-xs text-gray-400 mt-2">Recommended size: 1800x1200 pixels</p>
            </div>
        </div>
        
        <!-- Upload Progress -->
        <div id="uploadProgress" class="hidden mt-4">
            <div class="bg-gray-200 rounded-full h-2">
                <div id="progressBar" class="bg-rose-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-sm text-gray-600 mt-2">Uploading...</p>
        </div>
        
        <!-- Upload Button -->
        <button id="uploadBtn" onclick="uploadFrame()" disabled
                class="mt-6 w-full bg-gradient-to-r from-rose-500 to-pink-500 hover:from-rose-600 hover:to-pink-600
                       active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed
                       text-white font-bold py-4 px-8 rounded-xl text-lg
                       shadow-xl transform transition-all duration-200 touch-manipulation">
            <i class="fas fa-upload mr-3"></i>
            Upload Frame
        </button>
    </div>

    <!-- Frame Guidelines -->
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mt-8">
        <h3 class="text-lg font-semibold text-blue-900 mb-3">
            <i class="fas fa-info-circle text-blue-600 mr-2"></i>
            Frame Guidelines
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800">
            <div>
                <h4 class="font-semibold mb-2">Image Requirements:</h4>
                <ul class="space-y-1">
                    <li>• <strong>Format:</strong> PNG with transparency preferred</li>
                    <li>• <strong>Size:</strong> 1800x1200 pixels recommended</li>
                    <li>• <strong>Max file size:</strong> 10MB</li>
                </ul>
            </div>
            <div>
                <h4 class="font-semibold mb-2">Design Tips:</h4>
                <ul class="space-y-1">
                    <li>• Leave center area transparent for photos</li>
                    <li>• Use high contrast colors for visibility</li>
                    <li>• Consider wedding theme and colors</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl p-6 shadow-xl max-w-sm w-full text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-4 border-rose-500 border-t-transparent mx-auto mb-4"></div>
            <span id="loadingText" class="text-gray-700">Processing...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedFile = null;

// FORCE FRAME RELOAD
document.addEventListener('DOMContentLoaded', function() {
    console.log('FORCING FRAME RELOAD ON SETTINGS PAGE');
    
    setTimeout(() => {
        const frameImg = document.querySelector('img[alt="Current Frame"]');
        if (frameImg) {
            const originalSrc = frameImg.src;
            console.log('Original frame src:', originalSrc);
            
            // Force reload with new timestamp
            const newSrc = originalSrc.split('?')[0] + '?v=' + Date.now();
            frameImg.src = newSrc;
            console.log('New frame src:', newSrc);
        }
    }, 1000);
});

document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('frameUpload');
    const uploadBtn = document.getElementById('uploadBtn');
    const loadingModal = document.getElementById('loadingModal');
    const loadingText = document.getElementById('loadingText');

    fileInput.addEventListener('change', function(e) {
        selectedFile = e.target.files[0];
        if (selectedFile) {
            document.getElementById('uploadArea').innerHTML = `
                <i class="fas fa-image text-4xl text-rose-500 mb-4"></i>
                <p class="text-lg text-gray-700 mb-2">${selectedFile.name}</p>
                <p class="text-sm text-gray-500">Ready to upload</p>
            `;
            uploadBtn.disabled = false;
        }
    });
});

function showLoading(text) {
    loadingText.textContent = text;
    document.getElementById('loadingModal').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loadingModal').classList.add('hidden');
}

function uploadFrame() {
    if (!selectedFile) {
        alert('Please select a frame image first');
        return;
    }

    const formData = new FormData();
    formData.append('frame', selectedFile);

    showLoading('Uploading frame...');

    fetch('/settings/api/frame/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            alert('Frame uploaded successfully!');
            location.reload();
        } else {
            alert('Upload failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        hideLoading();
        alert('Upload failed: ' + error.message);
    });
}

function removeFrame() {
    if (!confirm('Are you sure you want to remove the current frame? This cannot be undone.')) {
        return;
    }

    showLoading('Removing frame...');

    fetch('/settings/api/frame/remove', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            alert('Frame removed successfully!');
            location.reload();
        } else {
            alert('Remove failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        hideLoading();
        alert('Remove failed: ' + error.message);
    });
}
</script>
{% endblock %}