<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PhotoBooth</title>
    <link href="{{ url_for('static', filename='css/tailwind.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/fontawesome.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/fixes.css') }}?v=20250909" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/booth.css') }}" rel="stylesheet">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body class="bg-gradient-to-br from-rose-50 via-pink-50 to-amber-50 min-h-screen overflow-hidden touch-manipulation">
    <!-- Background Decorations -->
    <div class="fixed inset-0 pointer-events-none overflow-hidden">
        <div class="absolute -top-4 -left-4 w-16 h-16 md:w-24 md:h-24 bg-rose-200 rounded-full opacity-30 animate-pulse"></div>
        <div class="absolute top-20 right-8 w-12 h-12 md:w-16 md:h-16 bg-pink-200 rounded-full opacity-40 animate-pulse delay-1000"></div>
        <div class="absolute bottom-32 left-8 w-20 h-20 md:w-28 md:h-28 bg-amber-200 rounded-full opacity-25 animate-pulse delay-2000"></div>
        <div class="absolute -bottom-8 -right-8 w-24 h-24 md:w-32 md:h-32 bg-rose-300 rounded-full opacity-20 animate-pulse delay-3000"></div>
    </div>

    <!-- Main Container -->
    <div class="relative z-10 min-h-screen flex flex-col safe-area-inset">
        <!-- Camera Container - Full available space -->
        <div class="flex-1 flex items-center justify-center px-4 py-4" style="padding-bottom: 100px; margin-top: 20px;">
            <!-- Camera Preview - Takes remaining space -->
            <div id="cameraContainer" class="relative w-full max-w-md sm:max-w-lg md:max-w-xl mx-auto" style="aspect-ratio: 4/6; max-height: calc(100vh - 160px);">
                <video id="cameraPreview" 
                       class="w-full h-full rounded-2xl shadow-2xl border-4 border-white bg-gray-800 object-cover"
                       style="z-index: 10; aspect-ratio: 4/6; object-fit: cover;"
                       autoplay muted playsinline>
                </video>
                
                <!-- FRAME OVERLAY CANVAS - LOADS AFTER CAMERA RUNNING -->
                <canvas id="frameOverlayCanvas" 
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; pointer-events: none; border-radius: 1rem; opacity: 0; display: none;"
                        width="800" height="1200">
                </canvas>
                
                <!-- Camera Error State -->
                <div id="cameraError" class="absolute inset-0 bg-red-900 rounded-2xl flex items-center justify-center hidden">
                    <div class="text-center px-4">
                        <i class="fas fa-exclamation-triangle text-4xl md:text-6xl text-white mb-3"></i>
                        <p class="text-white text-lg md:text-xl mb-2">Camera Access Required</p>
                        <p class="text-gray-200 text-sm">
                            Please refresh and allow camera access
                        </p>
                    </div>
                </div>

                <!-- Camera Controls Overlay -->
                <div class="absolute top-4 right-4 flex space-x-2">
                    <button id="switchCameraBtn" 
                            class="bg-black bg-opacity-50 hover:bg-opacity-70 text-white p-2 rounded-full transition-all duration-200 hidden">
                        <i class="fas fa-sync-alt text-sm"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- FIXED CAPTURE BUTTON - ALWAYS AT BOTTOM -->
        <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/20 to-transparent backdrop-blur-sm" style="z-index: 200;">
            <div class="max-w-md sm:max-w-lg md:max-w-xl lg:max-w-2xl mx-auto">
                <button id="captureBtn" 
                        class="w-full bg-gradient-to-r from-rose-500 to-pink-500 hover:from-rose-600 hover:to-pink-600
                               active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed
                               text-white font-bold py-4 px-6 rounded-2xl text-lg
                               shadow-2xl transform transition-all duration-200 ease-in-out
                               border-2 border-white hover:border-rose-200 touch-manipulation"
                        style="min-height: 60px;">
                    <i class="fas fa-camera mr-2 text-base"></i>
                    <span id="captureText">Start Photo Session</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Countdown Overlay -->
    <div id="countdownOverlay" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="text-center">
                <div id="countdownNumber" 
                     class="text-white text-[8rem] md:text-[12rem] lg:text-[16rem] font-bold leading-none 
                            animate-pulse drop-shadow-2xl">
                    3
                </div>
                <p class="text-white text-2xl md:text-3xl lg:text-4xl mt-4 animate-bounce">
                    Get Ready! <i class="fas fa-camera ml-2"></i>
                </p>
            </div>
        </div>
    </div>

    <!-- Photo Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-95 z-50 hidden">
        <div class="min-h-screen flex flex-col items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-h-screen overflow-hidden flex flex-col" style="width: 480px; max-width: 95vw;">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-rose-500 to-pink-500 text-white p-3 rounded-t-2xl flex-shrink-0">
                    <h2 class="text-lg md:text-xl font-bold text-center flex items-center justify-center">
                        <i class="fas fa-star mr-2 text-yellow-200"></i>
                        How does it look?
                        <i class="fas fa-star ml-2 text-yellow-200"></i>
                    </h2>
                </div>
                
                <!-- Photo Preview - ACTUAL 4x6 SIZE (4" wide x 6" tall at 72dpi = 288x432px) -->
                <div class="flex-1 p-4 flex items-center justify-center" style="min-height: 0;">
                    <div class="bg-white rounded-lg border-2 border-gray-200 shadow-lg" style="width: 400px; height: 600px;">
                        <img id="previewImage" 
                             class="w-full h-full object-contain rounded-lg" 
                             style="width: 400px; height: 600px; background-color: #ffffff;"
                             src="" alt="Photo Preview">
                    </div>
                </div>
                
                <!-- Printer Error Notifications -->
                {% if print_allowance.error_status and print_allowance.error_status.has_errors %}
                <div class="mx-4 mb-3 p-3 bg-red-600 text-white rounded-lg border border-red-700 shadow-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle text-xl mr-3"></i>
                        <div class="flex-1">
                            <h3 class="font-bold text-sm">Printer Error</h3>
                            <p class="text-xs opacity-90">{{ print_allowance.error_status.latest_error.error_message if print_allowance.error_status.latest_error else 'Printer has active errors' }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Ink Level Notifications -->
                {% if print_count_status.enabled %}
                    {% if print_count_status.is_empty %}
                    <div class="mx-4 mb-3 p-3 bg-red-500 text-white rounded-lg border border-red-600 shadow-lg">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-xl mr-3"></i>
                            <div>
                                <h3 class="font-bold text-sm">Cartridge Empty</h3>
                                <p class="text-xs opacity-90">Printing disabled. Please replace the ink cartridge.</p>
                            </div>
                        </div>
                    </div>
                    {% elif print_count_status.is_low %}
                    <div class="mx-4 mb-3 p-3 bg-yellow-500 text-white rounded-lg border border-yellow-600 shadow-lg">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-xl mr-3"></i>
                            <div>
                                <h3 class="font-bold text-sm">Low Ink Warning</h3>
                                <p class="text-xs opacity-90">Only {{ print_count_status.remaining }} prints remaining.</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endif %}
                
                <!-- Action Buttons -->
                <div class="p-4 flex-shrink-0">
                    <div class="flex flex-col space-y-3 md:flex-row md:space-y-0 md:space-x-4 justify-center">
                        <button id="printBtn" 
                                class="flex-1 md:flex-none 
                                       {% if print_allowance.allowed %}bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600{% else %}bg-gray-500 cursor-not-allowed{% endif %}
                                       active:scale-95 text-white font-bold py-4 px-6 md:px-8 rounded-xl text-lg
                                       shadow-xl transform transition-all duration-200 ease-in-out
                                       border-2 border-white {% if print_allowance.allowed %}hover:border-green-200{% endif %} touch-manipulation"
                                {% if not print_allowance.allowed %}disabled title="{{ print_allowance.reason }}"{% endif %}>
                            <i class="fas {% if print_allowance.allowed %}fa-print{% else %}fa-ban{% endif %} mr-2"></i>
                            {% if print_allowance.allowed %}Print Photo{% else %}Cannot Print{% endif %}
                        </button>
                        
                        <button id="retakeBtn" 
                                class="flex-1 md:flex-none bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600
                                       active:scale-95 text-white font-bold py-4 px-6 md:px-8 rounded-xl text-lg
                                       shadow-xl transform transition-all duration-200 ease-in-out
                                       border-2 border-white hover:border-amber-200 touch-manipulation">
                            <i class="fas fa-redo mr-2"></i>
                            Take Another
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="text-center">
                <div class="animate-spin rounded-full h-20 w-20 md:h-32 md:w-32 border-4 md:border-8 border-white border-t-rose-500 mx-auto mb-6"></div>
                <p id="loadingText" class="text-white text-lg md:text-2xl">Processing your photo...</p>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" 
         class="fixed top-4 md:top-8 left-4 right-4 md:left-1/2 md:right-auto md:transform md:-translate-x-1/2 
                bg-green-500 text-white px-6 py-3 md:px-8 md:py-4 
                rounded-xl md:rounded-full shadow-xl z-50 hidden animate-bounce text-center">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="successText">Photo printed successfully!</span>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" 
         class="fixed top-4 md:top-8 left-4 right-4 md:left-1/2 md:right-auto md:transform md:-translate-x-1/2 
                bg-red-500 text-white px-6 py-3 md:px-8 md:py-4 
                rounded-xl md:rounded-full shadow-xl z-50 hidden text-center">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <span id="errorText">Something went wrong!</span>
    </div>

    <script src="{{ url_for('static', filename='js/camera-debug.js') }}"></script>
    <script src="{{ url_for('static', filename='js/booth.js') }}"></script>
    <script>
    // CANVAS FRAME OVERLAY LOADS AFTER CAMERA IS RUNNING
    document.addEventListener('DOMContentLoaded', function() {
        console.log('INITIALIZING CANVAS FRAME OVERLAY');
        
        const canvas = document.getElementById('frameOverlayCanvas');
        const ctx = canvas ? canvas.getContext('2d') : null;
        const video = document.getElementById('cameraPreview');
        let frameLoaded = false;
        let frameImage = null;
        
        function loadFrameImage() {
            if (!frameImage) {
                frameImage = new Image();
                frameImage.crossOrigin = 'anonymous';
                frameImage.onload = function() {
                    console.log('FRAME IMAGE LOADED SUCCESSFULLY');
                    drawFrameOnCanvas();
                };
                frameImage.onerror = function() {
                    console.log('FRAME IMAGE FAILED TO LOAD');
                };
                frameImage.src = "{{ url_for('static', filename='frames/current.png') }}?v={{ timestamp }}";
            }
        }
        
        function drawFrameOnCanvas() {
            if (canvas && ctx && frameImage && !frameLoaded) {
                console.log('DRAWING FRAME ON CANVAS');
                
                // Set canvas dimensions to match container
                const containerRect = document.getElementById('cameraContainer').getBoundingClientRect();
                canvas.width = containerRect.width;
                canvas.height = containerRect.height;
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw frame image to fill canvas
                ctx.drawImage(frameImage, 0, 0, canvas.width, canvas.height);
                
                // Show canvas
                canvas.style.display = 'block';
                canvas.style.opacity = '1';
                canvas.style.position = 'absolute';
                canvas.style.top = '0';
                canvas.style.left = '0';
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.zIndex = '200';
                canvas.style.pointerEvents = 'none';
                canvas.style.borderRadius = '1rem';
                
                frameLoaded = true;
                console.log('CANVAS FRAME OVERLAY ACTIVATED');
            }
        }
        
        function enforceCanvasOverlay() {
            if (canvas && frameLoaded) {
                canvas.style.display = 'block';
                canvas.style.opacity = '1';
                canvas.style.position = 'absolute';
                canvas.style.top = '0';
                canvas.style.left = '0';
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.zIndex = '200';
                canvas.style.pointerEvents = 'none';
                canvas.style.borderRadius = '1rem';
            }
        }
        
        // Wait for camera to be fully playing before showing frame
        if (video) {
            video.addEventListener('playing', function() {
                console.log('VIDEO PLAYING EVENT - LOADING FRAME IMAGE');
                // Load frame image first, then it will auto-draw
                setTimeout(loadFrameImage, 500);
            });
        }
        
        // Periodic enforcement only after frame is initially loaded
        setInterval(function() {
            if (frameLoaded) {
                enforceCanvasOverlay();
                // Redraw frame if canvas was cleared
                if (ctx) {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const isEmpty = !imageData.data.some(channel => channel !== 0);
                    if (isEmpty && frameImage) {
                        console.log('REDRAWING FRAME ON CANVAS');
                        drawFrameOnCanvas();
                    }
                }
            }
        }, 3000);
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (frameLoaded && frameImage && canvas && ctx) {
                console.log('WINDOW RESIZED - REDRAWING CANVAS');
                setTimeout(drawFrameOnCanvas, 100);
            }
        });
        
        console.log('CANVAS FRAME OVERLAY INITIALIZED');
    });
    </script>
</body>
</html>